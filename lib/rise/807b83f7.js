"use strict";(self.wpRiseJsonp=self.wpRiseJsonp||[]).push([["profiler"],{34997:(fe,k,d)=>{d.r(k),d.d(k,{DEFAULT_RUM_PROFILER_CONFIGURATION:()=>E,createRumProfiler:()=>Z});var I=d(42517),p=d(31469),j=d(12409),T=d(70203),F=d(53215),w=d(20776),y=d(32665);function U(e){let n=0;for(const a of e)a.stackId!==void 0&&n++;return n}const g=new Map;function pe(){g.clear()}function B(e,n){g.set(n,e)}function C(e){return g.get(e)}function P(e){for(const n of g.keys())n<e&&g.delete(n)}function V({rawRumEvent:e,startTime:n}){if(e.type!==y.bb.LONG_TASK)return;const a=e.long_task.id;B(a,n)}var G=d(30284),J=d(14885);const H=(e,n,a)=>{const{profilingEndpointBuilder:o,applicationId:l}=n,m=x(e,n,a),c=K(e,m),h=o.build("fetch",c);return(0,G.A2)("Sending profile to public profiling intake",{profilingIntakeURL:h,applicationId:l,sessionId:a}),fetch(h,{body:c.data,method:"POST"})};function x(e,n,a){const o=(0,J.m5)(n),l=X(e,n.applicationId,a),m=z(o);return{...l,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:m.join(","),_dd:{clock_drift:(0,p.TP)()}}}function z(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}function K(e,n){const a=new Blob([JSON.stringify(e)],{type:"application/json"}),o=new FormData;return o.append("event",new Blob([JSON.stringify(n)],{type:"application/json"}),"event.json"),o.append("wall-time.json",a,"wall-time.json"),{data:o,bytesCount:0}}function X(e,n,a){const o={application:{id:n}};a&&(o.session={id:a});const l=Array.from(new Set(e.views.map(c=>c.viewId)));l.length&&(o.view={id:l});const m=e.longTasks.map(c=>c.id).filter(c=>c!==void 0);return m.length&&(o.long_task={id:m}),o}const Q={sendProfile:H},W=/\/(?![vV]\d{1,2}\/)([^/\d?]*\d+[^/?]*)/g;function Y(e){return e?e.replace(W,"/?"):"/"}const S=(e,n)=>e||Y(n),E={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function Z(e,n,a,o,l=E){const m=(0,y.s5)(y.do.LONG_ANIMATION_FRAME);let c;const h=[];let r={state:"stopped"};function $(t){r.state!=="running"&&(c=t?{startClocks:t.startClocks,viewId:t.id,viewName:S(t.name,document.location.pathname)}:void 0,h.push((0,I.q)(e,window,"visibilitychange",ne).stop,(0,I.q)(e,window,"beforeunload",se).stop),b())}async function q(){await L("stopped"),h.forEach(t=>t()),P((0,p.M8)().relative),o.set({status:"stopped",error_reason:void 0})}function _(t){if(t.state==="running")return{cleanupTasks:t.cleanupTasks,observer:t.observer};const s=[];let i;if(e.trackLongTasks){i=new PerformanceObserver(te),i.observe({entryTypes:[oe()]});const u=n.subscribe(12,v=>{V(v)});s.push(()=>i?.disconnect()),s.push(u.unsubscribe)}const f=n.subscribe(2,u=>{const v={viewId:u.id,viewName:S(u.name,document.location.pathname),startClocks:u.startClocks};D(v),c=v});return s.push(f.unsubscribe),{cleanupTasks:s,observer:i}}function b(){const t=(0,j.V)().Profiler;if(!t)throw o.set({status:"error",error_reason:"not-supported-by-browser"}),new Error("RUM Profiler is not supported in this browser.");O(r).catch(T.Dx);const{cleanupTasks:s,observer:i}=_(r);let f;try{f=new t({sampleInterval:l.sampleIntervalMs,maxBufferSize:Math.round(l.collectIntervalMs*1.5/l.sampleIntervalMs)})}catch(u){u instanceof Error&&u.message.includes("disabled by Document Policy")?(F.Vy.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",u),o.set({status:"error",error_reason:"missing-document-policy-header"})):o.set({status:"error",error_reason:"unexpected-exception"});return}o.set({status:"running",error_reason:void 0}),r={state:"running",startClocks:(0,p.M8)(),profiler:f,timeoutId:(0,w.wg)(b,l.collectIntervalMs),longTasks:[],views:[],cleanupTasks:s,observer:i},D(c),f.addEventListener("samplebufferfull",M)}async function O(t){var s,i;if(t.state!=="running")return;R((i=(s=t.observer)===null||s===void 0?void 0:s.takeRecords())!==null&&i!==void 0?i:[]),(0,w.DJ)(t.timeoutId),t.profiler.removeEventListener("samplebufferfull",M);const{startClocks:f,longTasks:u,views:v}=t,le=(0,p.M8)();await t.profiler.stop().then(N=>{const A=(0,p.M8)(),ce=u.length>0,ue=(0,p.vk)(f.timeStamp,A.timeStamp)<l.minProfileDurationMs,de=U(N.samples)<l.minNumberOfSamples;!ce&&(ue||de)||(ee(Object.assign(N,{startClocks:f,endClocks:A,clocksOrigin:(0,p.Oc)(),longTasks:u,views:v,sampleInterval:l.sampleIntervalMs})),P(le.relative))}).catch(T.Dx)}async function L(t){r.state==="running"&&(r.cleanupTasks.forEach(s=>s()),await O(r),r={state:t})}function D(t){r.state!=="running"||!t||r.views.push(t)}function ee(t){var s;const i=(s=a.findTrackedSession())===null||s===void 0?void 0:s.id;Q.sendProfile(t,e,i).catch(T.Dx)}function M(){b()}function te(t){R(t.getEntries())}function R(t){if(r.state==="running")for(const s of t){if(s.duration<l.sampleIntervalMs)continue;const i=(0,p.FR)(s.startTime),f=C(i.relative);r.longTasks.push({id:f,duration:s.duration,entryType:s.entryType,startClocks:i})}}function ne(){document.visibilityState==="hidden"&&r.state==="running"?L("paused").catch(T.Dx):document.visibilityState==="visible"&&r.state==="paused"&&b()}function se(){b()}function oe(){return m?"long-animation-frame":"longtask"}function re(){return r.state==="stopped"}function ie(){return r.state==="running"}function ae(){return r.state==="paused"}return{start:$,stop:q,isStopped:re,isRunning:ie,isPaused:ae}}}}]);
